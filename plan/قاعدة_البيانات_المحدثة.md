# تصميم قاعدة البيانات المحدثة لمركز إقرا

## 1. الجداول الحالية (المحسنة)

### 1.1 جدول الطلاب (students) - محدث

```sql
CREATE TABLE public.students (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  age INTEGER NOT NULL,
  grade TEXT NOT NULL, -- "ابتدائي أول"، "ابتدائي ثاني"، "ابتدائي ثالث"، etc.
  teacher_id UUID REFERENCES public.teachers(id),
  department TEXT NOT NULL CHECK (department IN ('quran', 'tajweed', 'tarbawi')),
  parts_memorized INTEGER DEFAULT 0,
  current_progress TEXT,
  previous_progress TEXT,
  is_active BOOLEAN DEFAULT true,
  parent_name TEXT,
  parent_phone TEXT,
  attendance INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- إضافة عمود جديد للمرحلة الدراسية التفصيلية
ALTER TABLE public.students ADD COLUMN grade_level TEXT;
-- القيم المحتملة: "ابتدائي أول"، "ابتدائي ثاني"، "ابتدائي ثالث"، "إعدادي أول"، "إعدادي ثاني"، "ثانوي أول"، "ثانوي ثاني"
```

### 1.2 جدول المشايخ (teachers) - محدث

```sql
CREATE TABLE public.teachers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  specialization TEXT NOT NULL,
  department TEXT NOT NULL CHECK (department IN ('quran', 'tajweed', 'tarbawi', 'sharia')),
  is_active BOOLEAN DEFAULT true,
  email TEXT,
  phone TEXT,
  experience INTEGER,
  bio TEXT, -- نبذة عن الشيخ
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

### 1.3 جدول جلسات القرآن (quran_sessions) - محدث

```sql
CREATE TABLE public.quran_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID REFERENCES public.students(id) ON DELETE CASCADE,
  teacher_id UUID REFERENCES public.teachers(id),
  session_date TIMESTAMPTZ DEFAULT now(),
  surah_name TEXT NOT NULL,
  verses_from INTEGER NOT NULL,
  verses_to INTEGER NOT NULL,
  performance_rating INTEGER CHECK (performance_rating >= 1 AND performance_rating <= 10),
  notes TEXT,
  attendance BOOLEAN DEFAULT true,
  audio_recording_url TEXT, -- رابط التسجيل الصوتي
  session_type TEXT CHECK (session_type IN ('ماضي بعيد', 'ماضي قريب', 'جديد')) DEFAULT 'جديد',
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

## 2. الجداول الجديدة المطلوبة

### 2.1 جدول الحضور والانصراف (attendance)

```sql
CREATE TABLE public.attendance (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  user_type TEXT NOT NULL CHECK (user_type IN ('student', 'teacher')),
  date DATE NOT NULL,
  check_in TIMESTAMPTZ,
  check_out TIMESTAMPTZ,
  status TEXT NOT NULL CHECK (status IN ('حاضر', 'غائب', 'متأخر', 'انصراف مبكر')) DEFAULT 'حاضر',
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  -- Ensure unique attendance record per user per day
  UNIQUE(user_id, date)
);

-- Add indexes for better performance
CREATE INDEX idx_attendance_user_id ON public.attendance(user_id);
CREATE INDEX idx_attendance_date ON public.attendance(date);
CREATE INDEX idx_attendance_user_type ON public.attendance(user_type);
```

### 2.2 جدول الامتحانات (exams)

```sql
CREATE TABLE public.exams (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  subject TEXT NOT NULL CHECK (subject IN ('قرآن', 'تجويد', 'تربوي')),
  description TEXT,
  exam_date TIMESTAMPTZ NOT NULL,
  max_score INTEGER NOT NULL DEFAULT 100,
  duration_minutes INTEGER DEFAULT 60,
  teacher_id UUID REFERENCES public.teachers(id),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- جدول نتائج الامتحانات
CREATE TABLE public.exam_results (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  exam_id UUID REFERENCES public.exams(id) ON DELETE CASCADE,
  student_id UUID REFERENCES public.students(id) ON DELETE CASCADE,
  score INTEGER NOT NULL CHECK (score >= 0),
  max_score INTEGER NOT NULL,
  notes TEXT,
  evaluated_by UUID REFERENCES public.teachers(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  -- Ensure unique result per student per exam
  UNIQUE(exam_id, student_id)
);

-- جدول أسئلة الامتحانات
CREATE TABLE public.exam_questions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  exam_id UUID REFERENCES public.exams(id) ON DELETE CASCADE,
  question_text TEXT NOT NULL,
  question_type TEXT CHECK (question_type IN ('نصي', 'اختياري', 'تلاوة')) DEFAULT 'نصي',
  max_score INTEGER DEFAULT 10,
  order_index INTEGER NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

### 2.3 جدول المحتوى التعليمي (educational_content)

```sql
CREATE TABLE public.educational_content (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  category TEXT NOT NULL CHECK (category IN ('عقيدة', 'فقه', 'سيرة', 'تفسير', 'حديث', 'تربية', 'لغة عربية')),
  title TEXT NOT NULL,
  description TEXT,
  content_type TEXT NOT NULL CHECK (content_type IN ('فيديو', 'صوت', 'PDF', 'مقال', 'صورة')),
  content_url TEXT NOT NULL,
  thumbnail_url TEXT,
  teacher_id UUID REFERENCES public.teachers(id),
  duration_minutes INTEGER,
  file_size BIGINT, -- حجم الملف بالبايت
  tags TEXT[], -- وسوم للتصنيف
  is_active BOOLEAN DEFAULT true,
  view_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- جدول الواجبات
CREATE TABLE public.assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  content_id UUID REFERENCES public.educational_content(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  due_date TIMESTAMPTZ,
  max_score INTEGER DEFAULT 100,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- جدول تسليمات الواجبات
CREATE TABLE public.assignment_submissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  assignment_id UUID REFERENCES public.assignments(id) ON DELETE CASCADE,
  student_id UUID REFERENCES public.students(id) ON DELETE CASCADE,
  submission_text TEXT,
  file_url TEXT,
  score INTEGER,
  notes TEXT,
  submitted_at TIMESTAMPTZ DEFAULT now(),
  evaluated_at TIMESTAMPTZ,
  evaluated_by UUID REFERENCES public.teachers(id),

  -- Ensure unique submission per student per assignment
  UNIQUE(assignment_id, student_id)
);
```

### 2.4 جدول الجداول الدراسية (schedules)

```sql
CREATE TABLE public.schedules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  description TEXT,
  start_time TIMESTAMPTZ NOT NULL,
  end_time TIMESTAMPTZ NOT NULL,
  recurring_type TEXT CHECK (recurring_type IN ('يومي', 'أسبوعي', 'شهري', 'مرة واحدة')) DEFAULT 'مرة واحدة',
  recurring_days INTEGER[], -- أيام الأسبوع [0,1,2,3,4,5,6] حيث 0 = الأحد
  location TEXT,
  teacher_id UUID REFERENCES public.teachers(id),
  schedule_type TEXT CHECK (schedule_type IN ('حلقة قرآن', 'درس تجويد', 'محاضرة تربوية', 'اجتماع', 'امتحان')) DEFAULT 'حلقة قرآن',
  is_active BOOLEAN DEFAULT true,
  notifications_enabled BOOLEAN DEFAULT true,
  notification_minutes_before INTEGER DEFAULT 15,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- جدول مشاركين الجداول
CREATE TABLE public.schedule_participants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  schedule_id UUID REFERENCES public.schedules(id) ON DELETE CASCADE,
  participant_id UUID NOT NULL,
  participant_type TEXT CHECK (participant_type IN ('student', 'teacher')) NOT NULL,
  is_required BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),

  -- Ensure unique participant per schedule
  UNIQUE(schedule_id, participant_id, participant_type)
);
```

### 2.5 جدول المكتبة العلمية (library)

```sql
CREATE TABLE public.library_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  author TEXT,
  description TEXT,
  item_type TEXT NOT NULL CHECK (item_type IN ('كتاب PDF', 'مقطع صوتي', 'فيديو', 'مقال', 'رابط خارجي')),
  file_url TEXT,
  external_url TEXT,
  thumbnail_url TEXT,
  category TEXT NOT NULL CHECK (category IN ('عقيدة', 'فقه', 'سيرة', 'تفسير', 'حديث', 'لغة عربية', 'أخلاق', 'تربية')),
  tags TEXT[],
  language TEXT DEFAULT 'العربية',
  file_size BIGINT,
  duration_minutes INTEGER,
  pages_count INTEGER,
  is_active BOOLEAN DEFAULT true,
  download_count INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,
  added_by UUID REFERENCES public.teachers(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

### 2.6 جدول الإعلانات والتنبيهات (announcements)

```sql
CREATE TABLE public.announcements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  announcement_type TEXT CHECK (announcement_type IN ('عام', 'للمشايخ', 'للطلاب', 'للإدارة')) DEFAULT 'عام',
  priority TEXT CHECK (priority IN ('عالي', 'متوسط', 'منخفض')) DEFAULT 'متوسط',
  is_active BOOLEAN DEFAULT true,
  show_popup BOOLEAN DEFAULT false,
  start_date TIMESTAMPTZ DEFAULT now(),
  end_date TIMESTAMPTZ,
  target_audience TEXT[], -- الجمهور المستهدف: ['all', 'teachers', 'students', 'department:quran', etc.]
  attachments TEXT[], -- روابط المرفقات
  created_by UUID REFERENCES public.teachers(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

### 2.7 جدول المستخدمين والصلاحيات (users)

```sql
CREATE TABLE public.users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  role TEXT NOT NULL CHECK (role IN ('طالب', 'مدرس', 'مشرف', 'إدارة')) DEFAULT 'طالب',
  permissions TEXT[], -- صلاحيات إضافية حسب الدور
  is_active BOOLEAN DEFAULT true,
  last_login TIMESTAMPTZ,
  email_verified BOOLEAN DEFAULT false,
  phone TEXT,
  avatar_url TEXT,
  preferences JSONB DEFAULT '{}', -- تفضيلات المستخدم
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- ربط المستخدمين بالطلاب والمشايخ
ALTER TABLE public.students ADD COLUMN user_id UUID REFERENCES public.users(id);
ALTER TABLE public.teachers ADD COLUMN user_id UUID REFERENCES public.users(id);
```

### 2.8 جدول سجل النشاط (activity_log)

```sql
CREATE TABLE public.activity_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES public.users(id),
  action TEXT NOT NULL, -- 'create', 'update', 'delete', 'login', 'logout'
  entity_type TEXT NOT NULL, -- 'student', 'teacher', 'session', 'exam', etc.
  entity_id UUID,
  old_values JSONB,
  new_values JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

## 3. تحديثات الجداول الحالية

### 3.1 تحديث جدول الاجتماعات (meetings)

```sql
ALTER TABLE public.meetings
ADD COLUMN meeting_type TEXT CHECK (meeting_type IN ('إداري', 'تربوي', 'أكاديمي', 'طوارئ')) DEFAULT 'إداري',
ADD COLUMN location TEXT,
ADD COLUMN is_virtual BOOLEAN DEFAULT false,
ADD COLUMN meeting_url TEXT,
ADD COLUMN max_participants INTEGER,
ADD COLUMN reminder_minutes_before INTEGER DEFAULT 30;
```

### 3.2 تحديث جدول دروس التجويد (tajweed_lessons)

```sql
ALTER TABLE public.tajweed_lessons
ADD COLUMN lesson_type TEXT CHECK (lesson_type IN ('نظري', 'عملي', 'تطبيقي')) DEFAULT 'نظري',
ADD COLUMN difficulty_level TEXT CHECK (difficulty_level IN ('مبتدئ', 'متوسط', 'متقدم')) DEFAULT 'مبتدئ',
ADD COLUMN prerequisites TEXT[],
ADD COLUMN learning_objectives TEXT[];
```

## 4. إنشاء الـ Indexes المحسنة

```sql
-- Indexes for better performance
CREATE INDEX idx_students_grade_level ON public.students(grade_level);
CREATE INDEX idx_students_department ON public.students(department);
CREATE INDEX idx_teachers_department ON public.teachers(department);
CREATE INDEX idx_quran_sessions_session_type ON public.quran_sessions(session_type);
CREATE INDEX idx_quran_sessions_date ON public.quran_sessions(session_date);
CREATE INDEX idx_attendance_user_date ON public.attendance(user_id, date);
CREATE INDEX idx_exams_subject ON public.exams(subject);
CREATE INDEX idx_exams_date ON public.exams(exam_date);
CREATE INDEX idx_exam_results_student ON public.exam_results(student_id);
CREATE INDEX idx_educational_content_category ON public.educational_content(category);
CREATE INDEX idx_schedules_start_time ON public.schedules(start_time);
CREATE INDEX idx_schedules_type ON public.schedules(schedule_type);
CREATE INDEX idx_announcements_type ON public.announcements(announcement_type);
CREATE INDEX idx_announcements_active ON public.announcements(is_active);
CREATE INDEX idx_activity_log_user ON public.activity_log(user_id);
CREATE INDEX idx_activity_log_created ON public.activity_log(created_at);
```

## 5. إنشاء الـ Policies للأمان

```sql
-- Policies for attendance table
CREATE POLICY "Users can view their own attendance" ON public.attendance
FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Teachers can view all attendance" ON public.attendance
FOR SELECT USING (
  EXISTS (
    SELECT 1 FROM public.users
    WHERE id = auth.uid() AND role IN ('مدرس', 'مشرف', 'إدارة')
  )
);

-- Policies for exams
CREATE POLICY "Students can view their exam results" ON public.exam_results
FOR SELECT USING (
  EXISTS (
    SELECT 1 FROM public.students
    WHERE id = student_id AND user_id = auth.uid()
  )
);

CREATE POLICY "Teachers can manage exams" ON public.exams
FOR ALL USING (
  EXISTS (
    SELECT 1 FROM public.users
    WHERE id = auth.uid() AND role IN ('مدرس', 'مشرف', 'إدارة')
  )
);

-- Policies for educational content
CREATE POLICY "Active content is viewable by all" ON public.educational_content
FOR SELECT USING (is_active = true);

CREATE POLICY "Teachers can manage content" ON public.educational_content
FOR ALL USING (
  EXISTS (
    SELECT 1 FROM public.users
    WHERE id = auth.uid() AND role IN ('مدرس', 'مشرف', 'إدارة')
  )
);
```

## 6. إنشاء الـ Functions والـ Triggers

```sql
-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Triggers for updated_at
CREATE TRIGGER update_students_updated_at BEFORE UPDATE ON public.students
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_teachers_updated_at BEFORE UPDATE ON public.teachers
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_quran_sessions_updated_at BEFORE UPDATE ON public.quran_sessions
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_exams_updated_at BEFORE UPDATE ON public.exams
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Function to log activity
CREATE OR REPLACE FUNCTION log_activity()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO public.activity_log (user_id, action, entity_type, entity_id, new_values)
        VALUES (auth.uid(), 'create', TG_TABLE_NAME, NEW.id, row_to_json(NEW));
        RETURN NEW;
    ELSIF TG_OP = 'UPDATE' THEN
        INSERT INTO public.activity_log (user_id, action, entity_type, entity_id, old_values, new_values)
        VALUES (auth.uid(), 'update', TG_TABLE_NAME, NEW.id, row_to_json(OLD), row_to_json(NEW));
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        INSERT INTO public.activity_log (user_id, action, entity_type, entity_id, old_values)
        VALUES (auth.uid(), 'delete', TG_TABLE_NAME, OLD.id, row_to_json(OLD));
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- Triggers for activity logging
CREATE TRIGGER log_students_activity AFTER INSERT OR UPDATE OR DELETE ON public.students
    FOR EACH ROW EXECUTE FUNCTION log_activity();

CREATE TRIGGER log_teachers_activity AFTER INSERT OR UPDATE OR DELETE ON public.teachers
    FOR EACH ROW EXECUTE FUNCTION log_activity();
```

## 7. Views للإحصائيات والتقارير

```sql
-- View for student statistics
CREATE VIEW public.student_statistics AS
SELECT
    s.id,
    s.name,
    s.grade_level,
    s.department,
    s.parts_memorized,
    COUNT(DISTINCT qs.id) as total_sessions,
    AVG(qs.performance_rating) as avg_rating,
    COUNT(DISTINCT CASE WHEN a.status = 'حاضر' THEN a.id END) as attendance_days,
    COUNT(DISTINCT CASE WHEN er.id IS NOT NULL THEN er.id END) as exams_taken,
    AVG(er.score) as avg_exam_score
FROM public.students s
LEFT JOIN public.quran_sessions qs ON s.id = qs.student_id
LEFT JOIN public.attendance a ON s.id = a.user_id AND a.user_type = 'student'
LEFT JOIN public.exam_results er ON s.id = er.student_id
GROUP BY s.id, s.name, s.grade_level, s.department, s.parts_memorized;

-- View for teacher statistics
CREATE VIEW public.teacher_statistics AS
SELECT
    t.id,
    t.name,
    t.department,
    COUNT(DISTINCT s.id) as total_students,
    COUNT(DISTINCT qs.id) as total_sessions,
    AVG(qs.performance_rating) as avg_session_rating,
    COUNT(DISTINCT e.id) as total_exams,
    COUNT(DISTINCT ec.id) as total_content
FROM public.teachers t
LEFT JOIN public.students s ON t.id = s.teacher_id
LEFT JOIN public.quran_sessions qs ON t.id = qs.teacher_id
LEFT JOIN public.exams e ON t.id = e.teacher_id
LEFT JOIN public.educational_content ec ON t.id = ec.teacher_id
GROUP BY t.id, t.name, t.department;
```

## 8. ملخص التحديثات

### الجداول المحسنة:

1. **students**: إضافة حقل grade_level للمرحلة الدراسية التفصيلية
2. **teachers**: إضافة حقل bio و department شامل
3. **quran_sessions**: إضافة session_type و audio_recording_url

### الجداول الجديدة:

1. **attendance**: نظام الحضور والانصراف الشامل
2. **exams**: نظام الامتحانات الكامل مع النتائج والأسئلة
3. **educational_content**: المحتوى التعليمي الشامل
4. **schedules**: الجداول الدراسية والمواعيد
5. **library_items**: المكتبة العلمية
6. **announcements**: الإعلانات والتنبيهات
7. **users**: نظام المستخدمين والصلاحيات
8. **activity_log**: سجل النشاط والتغييرات

### التحسينات:

1. **Indexes محسنة** للأداء السريع
2. **Policies للأمان** والصلاحيات
3. **Functions و Triggers** للأتمتة
4. **Views للإحصائيات** والتقارير

هذا التصميم يغطي جميع المتطلبات الجديدة مع الحفاظ على الأداء والأمان.
