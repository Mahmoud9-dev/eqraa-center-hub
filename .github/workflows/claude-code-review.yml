name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    name: Automated Code Review
    runs-on: ubuntu-latest

    # Only run on PR comments that mention @claude or on PR open/update
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR information
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            let pr_number;
            if (context.eventName === 'pull_request') {
              pr_number = context.payload.pull_request.number;
            } else if (context.eventName === 'issue_comment') {
              pr_number = context.payload.issue.number;
            }

            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            core.setOutput('pr_number', pr_number);
            core.setOutput('base_branch', pr.data.base.ref);
            core.setOutput('head_branch', pr.data.head.ref);
            core.setOutput('pr_title', pr.data.title);

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type checking
        id: type-check
        continue-on-error: true
        run: npm run type-check 2>&1 | tee type-check.log

      - name: Run linting
        id: lint
        continue-on-error: true
        run: npm run lint 2>&1 | tee lint.log

      - name: Run tests
        id: tests
        continue-on-error: true
        run: npm run test:ci 2>&1 | tee test.log

      - name: Get changed files
        id: changed-files
        run: |
          git fetch origin ${{ steps.pr-info.outputs.base_branch }}
          CHANGED_FILES=$(git diff --name-only origin/${{ steps.pr-info.outputs.base_branch }}...HEAD)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_sticky_comment: true
          prompt: |
            You are an expert code reviewer for a React + TypeScript + Vite project using Supabase.

            ## PR Information
            Title: ${{ steps.pr-info.outputs.pr_title }}
            Base Branch: ${{ steps.pr-info.outputs.base_branch }}
            Head Branch: ${{ steps.pr-info.outputs.head_branch }}

            ## Changed Files
            ${{ steps.changed-files.outputs.changed_files }}

            ## Test Results
            Type Check: ${{ steps.type-check.outcome }}
            Lint: ${{ steps.lint.outcome }}
            Tests: ${{ steps.tests.outcome }}

            ## Your Task
            Please review this pull request focusing on:

            1. **Code Quality**
               - TypeScript best practices and type safety
               - React hooks usage and component patterns
               - Proper error handling
               - Code organization and maintainability

            2. **Security**
               - XSS vulnerabilities
               - SQL injection risks (Supabase queries)
               - Authentication/authorization issues
               - Sensitive data exposure
               - OWASP Top 10 vulnerabilities

            3. **Performance**
               - Unnecessary re-renders
               - Inefficient algorithms or queries
               - Bundle size impact
               - Memory leaks

            4. **Testing**
               - Test coverage for new features
               - Edge cases handled
               - Integration test considerations

            5. **Accessibility**
               - ARIA attributes
               - Keyboard navigation
               - Screen reader compatibility

            6. **Best Practices**
               - Following project conventions
               - Proper use of Radix UI components
               - TanStack Query usage
               - Form validation with react-hook-form + Zod

            ## Review Format
            Provide your review in the following format:

            ### Summary
            [Brief overview of changes and overall assessment]

            ### Critical Issues üî¥
            [Any issues that must be fixed before merge]

            ### Warnings ‚ö†Ô∏è
            [Issues that should be addressed but not blocking]

            ### Suggestions üí°
            [Nice-to-have improvements]

            ### Positive Highlights ‚úÖ
            [What was done well]

            ### Test Results Analysis
            [Analysis of the CI test results and any failures]

            Please be specific and reference file paths and line numbers where applicable.

      - name: Upload logs as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: review-logs-${{ steps.pr-info.outputs.pr_number }}
          path: |
            type-check.log
            lint.log
            test.log
          retention-days: 7
